<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sentinel Shield</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                },
            },
        }
    </script>
</head>

<body class="bg-background text-foreground">
    <div id="navbar-container"></div>

    <main class="container mx-auto px-4 py-8">
        <div id="loading" class="flex items-center justify-center py-20">
            <i data-lucide="loader-2" class="h-8 w-8 animate-spin text-primary"></i>
        </div>

        <div id="admin-content" class="hidden space-y-6">
            <div class="flex items-center gap-3">
                <i data-lucide="shield" class="h-8 w-8 text-primary"></i>
                <div>
                    <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                    <p class="text-muted-foreground">Platform-wide security analytics and management</p>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="glass-card p-6">
                    <p class="text-sm font-medium text-muted-foreground uppercase">Total Users</p>
                    <div class="flex items-center justify-between mt-2">
                        <div class="text-2xl font-bold" id="admin-total-users">0</div>
                        <i data-lucide="users" class="h-4 w-4 text-muted-foreground"></i>
                    </div>
                </div>
                <div class="glass-card p-6">
                    <p class="text-sm font-medium text-muted-foreground uppercase">Total Scans</p>
                    <div class="flex items-center justify-between mt-2">
                        <div class="text-2xl font-bold" id="admin-total-scans">0</div>
                        <i data-lucide="activity" class="h-4 w-4 text-muted-foreground"></i>
                    </div>
                </div>
                <div class="glass-card p-6 border-l-4 border-l-red-500">
                    <p class="text-sm font-medium text-muted-foreground uppercase">Threats Detected</p>
                    <div class="flex items-center justify-between mt-2">
                        <div class="text-2xl font-bold" id="admin-threats">0</div>
                        <i data-lucide="alert-triangle" class="h-4 w-4 text-red-500"></i>
                    </div>
                </div>
                <div class="glass-card p-6 border-l-4 border-l-green-500">
                    <p class="text-sm font-medium text-muted-foreground uppercase">Safe Scans</p>
                    <div class="flex items-center justify-between mt-2">
                        <div class="text-2xl font-bold" id="admin-safe">0</div>
                        <i data-lucide="shield" class="h-4 w-4 text-green-500"></i>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-card p-6">
                    <h3 class="text-lg font-semibold mb-4">Scans by Type</h3>
                    <div class="h-[300px] flex items-center justify-center">
                        <canvas id="adminTypeChart"></canvas>
                    </div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-lg font-semibold mb-4">Threat Distribution</h3>
                    <div class="h-[300px] flex items-center justify-center">
                        <canvas id="adminThreatChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- All Scans Table -->
            <div class="glass-card">
                <div class="flex justify-between items-center p-6 border-b border-border">
                    <h2 class="text-lg font-semibold">All Platform Scans</h2>
                    <select id="typeFilter"
                        class="bg-background border border-border rounded-md px-3 py-1 text-sm outline-none focus:ring-2 focus:ring-primary">
                        <option value="all">All Types</option>
                        <option value="url">URL</option>
                        <option value="email">Email</option>
                        <option value="message">Message</option>
                        <option value="file">File</option>
                        <option value="website">Website</option>
                        <option value="qr">QR</option>
                        <option value="domain">Domain</option>
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-muted/50 border-y border-border">
                            <tr>
                                <th class="text-left p-4 font-medium">Date</th>
                                <th class="text-left p-4 font-medium">User ID</th>
                                <th class="text-left p-4 font-medium">Type</th>
                                <th class="text-left p-4 font-medium">Input</th>
                                <th class="text-left p-4 font-medium">Result</th>
                                <th class="text-left p-4 font-medium">Risk</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth } from './js/auth.js';
        import { ui } from './js/ui.js';
        import { supabaseClient } from './js/supabase.js';

        ui.init();

        const loading = document.getElementById('loading');
        const content = document.getElementById('admin-content');
        let allPlatformScans = [];

        const initAdmin = async () => {
            // Require admin privileges
            const user = await auth.checkAuth(true, true);
            if (!user) return;

            try {
                // Fetch All Scans
                const { data: scans, error: scansError } = await supabaseClient
                    .from('scans')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);

                if (scansError) throw scansError;
                allPlatformScans = scans;

                // Fetch User Count
                const { count: userCount, error: userError } = await supabaseClient
                    .from('profiles')
                    .select('*', { count: 'exact', head: true });

                if (userError) throw userError;

                updateAdminStats(scans, userCount);
                updateAdminCharts(scans);
                renderAdminTable(scans);

                loading.classList.add('hidden');
                content.classList.remove('hidden');
                lucide.createIcons();
            } catch (err) {
                console.error('Admin init error:', err);
                alert('Access denied or data fetch failed');
            }
        };

        const updateAdminStats = (scans, userCount) => {
            const total = scans.length;
            const threats = scans.filter(s =>
                !['SAFE', 'LEGITIMATE', 'SAFE_FILE', 'LOW_RISK'].includes(s.classification)
            ).length;
            const safe = total - threats;

            document.getElementById('admin-total-users').textContent = userCount || 0;
            document.getElementById('admin-total-scans').textContent = total;
            document.getElementById('admin-threats').textContent = threats;
            document.getElementById('admin-safe').textContent = safe;
        };

        const renderAdminTable = (scans) => {
            const tableBody = document.getElementById('adminTableBody');
            tableBody.innerHTML = scans.map(scan => `
                <tr class="border-b border-border hover:bg-muted/50 transition-colors">
                    <td class="p-4 whitespace-nowrap">${new Date(scan.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                    <td class="p-4 font-mono text-xs text-muted-foreground">${scan.user_id.slice(0, 8)}...</td>
                    <td class="p-4 capitalize">${scan.scan_type}</td>
                    <td class="p-4 truncate max-w-xs">${scan.input_value}</td>
                    <td class="p-4">
                         <span class="px-2 py-1 rounded-full text-xs font-medium 
                            ${['SAFE', 'LEGITIMATE', 'SAFE_FILE'].includes(scan.classification) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${scan.classification}
                        </span>
                    </td>
                    <td class="p-4">
                         <span class="px-2 py-1 rounded text-xs font-medium uppercase
                            ${scan.risk_level === 'low' ? 'bg-green-100 text-green-700' : scan.risk_level === 'medium' ? 'bg-orange-100 text-orange-700' : 'bg-red-100 text-red-700'}">
                            ${scan.risk_level}
                        </span>
                    </td>
                </tr>
            `).join('');
        };

        const updateAdminCharts = (scans) => {
            // Type Chart
            const byType = scans.reduce((acc, s) => {
                acc[s.scan_type] = (acc[s.scan_type] || 0) + 1;
                return acc;
            }, {});

            new Chart(document.getElementById('adminTypeChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(byType),
                    datasets: [{
                        data: Object.values(byType),
                        backgroundColor: ['#0EA5E9', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Threat Chart
            const byClass = scans.reduce((acc, s) => {
                acc[s.classification] = (acc[s.classification] || 0) + 1;
                return acc;
            }, {});

            new Chart(document.getElementById('adminThreatChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(byClass),
                    datasets: [{
                        label: 'Count',
                        data: Object.values(byClass),
                        backgroundColor: '#0EA5E9'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        };

        document.getElementById('typeFilter').addEventListener('change', (e) => {
            const filter = e.target.value;
            const filtered = filter === 'all'
                ? allPlatformScans
                : allPlatformScans.filter(s => s.scan_type === filter);
            renderAdminTable(filtered);
        });

        initAdmin();
    </script>
</body>

</html>