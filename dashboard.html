<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sentinel Shield</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                        safe: "hsl(var(--safe))",
                        warning: "hsl(var(--warning))",
                        danger: "hsl(var(--danger))",
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                },
            },
        }
    </script>
</head>

<body class="bg-background text-foreground">
    <div id="navbar-container"></div>

    <main class="container mx-auto px-4 py-8">
        <div id="loading" class="flex items-center justify-center py-20">
            <i data-lucide="loader-2" class="h-8 w-8 animate-spin text-primary"></i>
        </div>

        <div id="dashboard-content" class="hidden">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-3xl font-bold">Dashboard</h1>
                    <p class="text-muted-foreground mt-1">Welcome back! Here's your security overview.</p>
                </div>
                <a href="scan/url.html"
                    class="inline-flex h-10 items-center justify-center rounded-md bg-primary px-4 text-sm font-medium text-primary-foreground hover:bg-primary/90">
                    New Scan <i data-lucide="arrow-right" class="ml-2 h-4 w-4"></i>
                </a>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Scans -->
                <div class="glass-card p-6">
                    <div class="flex items-center justify-between space-y-0 pb-2">
                        <p class="text-sm font-medium">Total Scans</p>
                        <i data-lucide="activity" class="h-4 w-4 text-muted-foreground"></i>
                    </div>
                    <div class="text-2xl font-bold" id="stat-total">0</div>
                </div>
                <!-- Threats Detected -->
                <div class="glass-card p-6 border-l-4 border-l-red-500">
                    <div class="flex items-center justify-between space-y-0 pb-2">
                        <p class="text-sm font-medium">Threats Detected</p>
                        <i data-lucide="shield-alert" class="h-4 w-4 text-red-500"></i>
                    </div>
                    <div class="text-2xl font-bold" id="stat-threats">0</div>
                </div>
                <!-- Safe Results -->
                <div class="glass-card p-6 border-l-4 border-l-green-500">
                    <div class="flex items-center justify-between space-y-0 pb-2">
                        <p class="text-sm font-medium">Safe Results</p>
                        <i data-lucide="shield-check" class="h-4 w-4 text-green-500"></i>
                    </div>
                    <div class="text-2xl font-bold" id="stat-safe">0</div>
                </div>
                <!-- Detection Rate -->
                <div class="glass-card p-6 border-l-4 border-l-orange-500">
                    <div class="flex items-center justify-between space-y-0 pb-2">
                        <p class="text-sm font-medium">Detection Rate</p>
                        <i data-lucide="shield" class="h-4 w-4 text-orange-500"></i>
                    </div>
                    <div class="text-2xl font-bold" id="stat-rate">0%</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glass-card p-6">
                    <h3 class="text-lg font-semibold mb-4">Scans by Type</h3>
                    <div class="h-[300px] flex items-center justify-center">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-lg font-semibold mb-4">Threat Distribution</h3>
                    <div class="h-[300px] flex items-center justify-center">
                        <canvas id="threatChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Scans -->
            <div class="glass-card">
                <div class="flex items-center justify-between p-6">
                    <h3 class="text-lg font-semibold">Recent Scans</h3>
                    <a href="history.html" class="text-sm font-medium text-primary hover:underline">View All</a>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-muted/50 border-y border-border">
                            <tr>
                                <th class="text-left p-4 font-medium">Date</th>
                                <th class="text-left p-4 font-medium">Type</th>
                                <th class="text-left p-4 font-medium">Input</th>
                                <th class="text-left p-4 font-medium">Result</th>
                                <th class="text-left p-4 font-medium">Score</th>
                            </tr>
                        </thead>
                        <tbody id="recentScansTable">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth } from './js/auth.js';
        import { ui } from './js/ui.js';
        import { supabaseClient } from './js/supabase.js';

        ui.init();

        const loading = document.getElementById('loading');
        const content = document.getElementById('dashboard-content');

        const initDashboard = async () => {
            const user = await auth.checkAuth();
            if (!user) return;

            try {
                // Fetch Scans
                const { data: scans, error: scansError } = await supabaseClient
                    .from('scans')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (scansError) throw scansError;

                // Fetch Stats (we'll calculate from all scans)
                const { data: allScans, error: statsError } = await supabaseClient
                    .from('scans')
                    .select('scan_type, classification, confidence_score')
                    .eq('user_id', user.id);

                if (statsError) throw statsError;

                updateStats(allScans);
                updateCharts(allScans);
                updateTable(scans);

                loading.classList.add('hidden');
                content.classList.remove('hidden');
                lucide.createIcons();
            } catch (err) {
                console.error('Dashboard error details:', err);
                const errorMessage = err.message || 'Unknown error';
                const errorDetails = err.details || (err.code ? `Error code: ${err.code}` : '');

                // Show more detailed alert for debugging
                alert(`Failed to load dashboard data: ${errorMessage}\n${errorDetails}\n\nPlease check the browser console for more details.`);

                loading.innerHTML = `
                    <div class="text-center p-8 bg-red-50 border border-red-200 rounded-lg max-w-lg mx-auto">
                        <i data-lucide="alert-circle" class="h-12 w-12 text-red-500 mx-auto mb-4"></i>
                        <h2 class="text-xl font-bold text-red-800 mb-2">Error Loading Dashboard</h2>
                        <p class="text-red-700 mb-4">${errorMessage}</p>
                        <p class="text-sm text-red-600 mb-6">${errorDetails}</p>
                        <button onclick="window.location.reload()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                            Retry
                        </button>
                    </div>
                `;
                lucide.createIcons();
            }
        };

        const updateStats = (scans) => {
            const total = scans.length;
            const threats = scans.filter(s =>
                ['PHISHING', 'MALWARE', 'SCAM', 'MALICIOUS_FILE', 'HIGH_RISK'].includes(s.classification)
            ).length;
            const safe = scans.filter(s =>
                ['SAFE', 'LEGITIMATE', 'SAFE_FILE', 'LOW_RISK'].includes(s.classification)
            ).length;
            const rate = total ? Math.round((threats / total) * 100) : 0;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-threats').textContent = threats;
            document.getElementById('stat-safe').textContent = safe;
            document.getElementById('stat-rate').textContent = `${rate}%`;
        };

        const updateTable = (scans) => {
            const tableBody = document.getElementById('recentScansTable');
            tableBody.innerHTML = scans.map(scan => `
                <tr class="border-b border-border hover:bg-muted/50 transition-colors">
                    <td class="p-4">${new Date(scan.created_at).toLocaleDateString()}</td>
                    <td class="p-4 uppercase text-xs font-semibold">${scan.scan_type}</td>
                    <td class="p-4 truncate max-w-xs">${scan.input_value}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium 
                            ${['SAFE', 'LEGITIMATE', 'SAFE_FILE'].includes(scan.classification) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${scan.classification}
                        </span>
                    </td>
                    <td class="p-4">${typeof scan.confidence_score === 'number' ? Math.round(scan.confidence_score) : 0}%</td>
                </tr>
            `).join('');
        };

        const updateCharts = (scans) => {
            // Type Chart
            const byType = scans.reduce((acc, s) => {
                acc[s.scan_type] = (acc[s.scan_type] || 0) + 1;
                return acc;
            }, {});

            new Chart(document.getElementById('typeChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(byType),
                    datasets: [{
                        data: Object.values(byType),
                        backgroundColor: ['#0EA5E9', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Threat Chart
            const byClass = scans.reduce((acc, s) => {
                acc[s.classification] = (acc[s.classification] || 0) + 1;
                return acc;
            }, {});

            new Chart(document.getElementById('threatChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(byClass),
                    datasets: [{
                        label: 'Count',
                        data: Object.values(byClass),
                        backgroundColor: '#0EA5E9'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        };

        initDashboard();
    </script>
</body>

</html>